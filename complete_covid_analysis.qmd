---
title: "COVID-19 Impact on Retail Employment: Complete Analysis"
author: "COVID Retail Employment Study"
date: "`r Sys.Date()`"
format: 
  html:
    toc: true
    toc-depth: 3
    code-fold: show
    theme: cosmo
    embed-resources: true
execute:
  warning: false
  message: false
  echo: true
---

# Executive Summary

This analysis examines COVID-19's impact on retail employment using IPUMS CPS data (2020-2022). Key findings: retail workers experienced 3.7 percentage point employment decline vs 2.2 points for non-retail, with 65.6% unemployment rate increase vs 56.4% for other industries.

# Setup and Data Loading

```{r setup}
library(tidyverse)
library(fixest)
library(modelsummary)
library(lubridate)
library(ggplot2)
library(scales)
library(viridis)

# Data path
# load data cps_00003.dat.gz after download to your computer. Use your own path c:/users/jdoe/OneDrive - Files
data_path <- "C:/Users/dgaudin/OneDrive - airmethods.com/Desktop/Seattle U/5300 econometrics/Final Challenge/data_local/cps_00003.dat.gz"

cat("=== IPUMS CPS COVID RETAIL EMPLOYMENT ANALYSIS ===\n")
```

```{r data-loading}
# Define column positions from IPUMS codebook
ipums_positions <- fwf_positions(
  start = c(1,   10,  116, 118, 119, 130, 137, 140, 146, 149, 152, 157, 52,  187, 189, 160, 170, 179),
  end =   c(4,   11,  117, 118, 121, 131, 139, 143, 148, 151, 153, 159, 65,  188, 190, 169, 178, 186),
  col_names = c("YEAR", "MONTH", "AGE", "SEX", "RACE", "EMPSTAT", "IND1990", "IND", 
                "UHRSWORKT", "AHRSWORKT", "WKSTAT", "EDUC", "WTFINL", 
                "COVIDTELEW", "COVIDUNAW", "FTOTVAL", "INCTOT", "INCWAGE")
)

# Load and clean data
cat("Loading IPUMS CPS data...\n")
cps_data <- read_fwf(gzfile(data_path), ipums_positions, show_col_types = FALSE) %>%
  mutate(across(everything(), as.numeric)) %>%
  filter(
    YEAR >= 2020 & YEAR <= 2022,
    MONTH >= 1 & MONTH <= 12,
    AGE >= 16,  # Working age population
    SEX %in% c(1, 2),
    EMPSTAT %in% c(10, 12, 20, 21, 22),  # Employed or unemployed (in labor force)
    !is.na(WTFINL), WTFINL > 0
  )

cat("Sample size after filtering:", nrow(cps_data), "\n")
```

```{r variable-creation}
# Create analysis variables
analysis_data <- cps_data %>%
  mutate(
    # Time variables
    date = as.Date(paste(YEAR, MONTH, "01", sep = "-")),
    post_covid = ifelse(date >= as.Date("2020-04-01"), 1, 0),
    covid_period = case_when(
      date < as.Date("2020-04-01") ~ "Pre-COVID",
      date >= as.Date("2020-04-01") & date < as.Date("2021-01-01") ~ "COVID Peak",
      date >= as.Date("2021-01-01") ~ "COVID Recovery",
      TRUE ~ "Other"
    ),
    
    # Demographics
    female = ifelse(SEX == 2, 1, 0),
    age_group = case_when(
      AGE >= 16 & AGE <= 24 ~ "16-24",
      AGE >= 25 & AGE <= 34 ~ "25-34", 
      AGE >= 35 & AGE <= 44 ~ "35-44",
      AGE >= 45 & AGE <= 54 ~ "45-54",
      AGE >= 55 & AGE <= 64 ~ "55-64",
      AGE >= 65 ~ "65+",
      TRUE ~ "Other"
    ),
    race_group = case_when(
      RACE == 100 ~ "White",
      RACE == 200 ~ "Black", 
      RACE >= 651 & RACE <= 652 ~ "Asian/PI",
      RACE >= 801 ~ "Multiracial",
      TRUE ~ "Other"
    ),
    education = case_when(
      EDUC <= 071 ~ "HS or Less",
      EDUC >= 072 & EDUC <= 092 ~ "Some College/Associates",
      EDUC >= 111 & EDUC <= 111 ~ "Bachelor's",
      EDUC >= 123 ~ "Graduate Degree",
      TRUE ~ "Other"
    ),
    
    # Employment variables
    employed = ifelse(EMPSTAT %in% c(10, 12), 1, 0),
    unemployed = ifelse(EMPSTAT %in% c(20, 21, 22), 1, 0),
    full_time = ifelse(WKSTAT %in% c(10, 11), 1, 0),
    part_time_economic = ifelse(WKSTAT %in% c(20, 21, 22), 1, 0),
    part_time_noneconomic = ifelse(WKSTAT %in% c(40, 41), 1, 0),
    
    # Industry classification (using IND1990)
    retail_industry = ifelse(IND1990 >= 580 & IND1990 <= 691, 1, 0),
    industry_group = case_when(
      IND1990 >= 580 & IND1990 <= 691 ~ "Retail Trade",
      IND1990 >= 641 & IND1990 <= 641 ~ "Food Service",
      IND1990 >= 812 & IND1990 <= 893 ~ "Professional Services",
      IND1990 >= 100 & IND1990 <= 392 ~ "Manufacturing",
      IND1990 >= 060 & IND1990 <= 060 ~ "Construction",
      IND1990 >= 831 & IND1990 <= 840 ~ "Healthcare",
      TRUE ~ "Other Industries"
    ),
    
    # COVID-specific work impacts
    covid_remote = ifelse(COVIDTELEW == 2, 1, 0),  # Worked remotely due to COVID
    covid_unable = ifelse(COVIDUNAW == 2, 1, 0),   # Unable to work due to COVID
    covid_work_impact = ifelse(covid_remote == 1 | covid_unable == 1, 1, 0),
    
    # Hours worked
    usual_hours = ifelse(UHRSWORKT <= 996, UHRSWORKT, NA),
    actual_hours = ifelse(AHRSWORKT <= 996, AHRSWORKT, NA),
    hours_reduction = ifelse(!is.na(usual_hours) & !is.na(actual_hours), 
                             usual_hours - actual_hours, NA),
    
    # Income 
    has_wage_income = ifelse(!is.na(INCWAGE) & INCWAGE > 0, 1, 0),
    log_wage_income = ifelse(INCWAGE > 0, log(INCWAGE), NA)
  )
```

# Data Quality Assessment

```{r data-quality}
cat("\n=== DATA QUALITY CHECK ===\n")
cat("Years:", paste(sort(unique(analysis_data$YEAR)), collapse = ", "), "\n")
cat("Months:", paste(sort(unique(analysis_data$MONTH)), collapse = ", "), "\n")
cat("Gender distribution:", round(prop.table(table(analysis_data$female)) * 100, 1), "\n")
cat("Employment status:", round(prop.table(table(analysis_data$employed)) * 100, 1), "\n")
cat("Retail workers:", sum(analysis_data$retail_industry), 
    "(", round(mean(analysis_data$retail_industry) * 100, 1), "%)\n")
```

# Research Question 1: Employment Health by Industry

```{r employment-summary}
# Summary statistics by industry and COVID period
employment_summary <- analysis_data %>%
  group_by(industry_group, covid_period) %>%
  summarise(
    n_workers = n(),
    employment_rate = weighted.mean(employed, WTFINL, na.rm = TRUE) * 100,
    unemployment_rate = weighted.mean(unemployed, WTFINL, na.rm = TRUE) * 100,
    pct_female = weighted.mean(female, WTFINL, na.rm = TRUE) * 100,
    pct_fulltime = weighted.mean(full_time, WTFINL, na.rm = TRUE) * 100,
    covid_remote_pct = weighted.mean(covid_remote, WTFINL, na.rm = TRUE) * 100,
    covid_unable_pct = weighted.mean(covid_unable, WTFINL, na.rm = TRUE) * 100,
    avg_usual_hours = weighted.mean(usual_hours, WTFINL, na.rm = TRUE),
    avg_actual_hours = weighted.mean(actual_hours, WTFINL, na.rm = TRUE),
    .groups = "drop"
  )

print(employment_summary)
```

# Research Question 2: Retail vs Non-Retail Comparison

```{r retail-comparison}
# Focus on retail vs other industries
retail_comparison <- analysis_data %>%
  group_by(retail_industry, post_covid) %>%
  summarise(
    n_workers = n(),
    employment_rate = weighted.mean(employed, WTFINL, na.rm = TRUE) * 100,
    unemployment_rate = weighted.mean(unemployed, WTFINL, na.rm = TRUE) * 100,
    covid_impact_rate = weighted.mean(covid_work_impact, WTFINL, na.rm = TRUE) * 100,
    pct_female = weighted.mean(female, WTFINL, na.rm = TRUE) * 100,
    avg_hours = weighted.mean(actual_hours, WTFINL, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    industry_type = ifelse(retail_industry == 1, "Retail", "Non-Retail"),
    period = ifelse(post_covid == 1, "Post-COVID", "Pre-COVID")
  )

print(retail_comparison)

# Calculate COVID impact
covid_impact_analysis <- retail_comparison %>%
  select(industry_type, period, employment_rate, unemployment_rate, covid_impact_rate) %>%
  pivot_longer(cols = c(employment_rate, unemployment_rate, covid_impact_rate), 
               names_to = "metric", values_to = "rate") %>%
  pivot_wider(names_from = period, values_from = rate) %>%
  mutate(
    covid_change = `Post-COVID` - `Pre-COVID`,
    pct_change = (covid_change / `Pre-COVID`) * 100
  )

print(covid_impact_analysis)
```

# Research Question 3: COVID Work Impact Patterns

```{r covid-impact-patterns}
# COVID-specific impacts
covid_summary <- analysis_data %>%
  filter(!is.na(covid_work_impact)) %>%
  group_by(retail_industry) %>%
  summarise(
    covid_remote_pct = weighted.mean(covid_remote, WTFINL, na.rm = TRUE) * 100,
    covid_unable_pct = weighted.mean(covid_unable, WTFINL, na.rm = TRUE) * 100,
    total_covid_impact = weighted.mean(covid_work_impact, WTFINL, na.rm = TRUE) * 100,
    .groups = "drop"
  ) %>%
  mutate(industry_type = ifelse(retail_industry == 1, "Retail", "Non-Retail"))

print(covid_summary)
```

# Regression Analysis

```{r regression-models}
# Model 1: Employment probability
model1 <- feols(
  employed ~ retail_industry * post_covid + female + age_group + race_group + education,
  data = analysis_data,
  weights = ~WTFINL,
  vcov = "hetero"
)

# Model 2: COVID work impact
covid_data <- analysis_data %>% filter(!is.na(covid_work_impact))
model2 <- feols(
  covid_work_impact ~ retail_industry + female + age_group + race_group + education,
  data = covid_data,
  weights = ~WTFINL,
  vcov = "hetero"
)

# Model 3: Hours worked (for employed workers)
hours_data <- analysis_data %>% filter(employed == 1, !is.na(actual_hours))
model3 <- feols(
  actual_hours ~ retail_industry * post_covid + female + age_group + race_group + education,
  data = hours_data,
  weights = ~WTFINL,
  vcov = "hetero"
)

# Display regression results
models_list <- list(
  "Employment" = model1,
  "COVID Impact" = model2,
  "Hours Worked" = model3
)

modelsummary(
  models_list,
  title = "COVID Impact on Retail Employment: Regression Results",
  notes = c(
    "Standard errors are heteroskedasticity-robust.",
    "All models use CPS final weights (WTFINL).",
    "Sample: 2020-2022 CPS data, working-age population (16+).",
    "*** p<0.001, ** p<0.01, * p<0.05"
  ),
  stars = TRUE,
  fmt = 3
)

# Individual model summaries
cat("\n=== MODEL 1: EMPLOYMENT PROBABILITY ===\n")
summary(model1)

cat("\n=== MODEL 2: COVID WORK IMPACT ===\n")
summary(model2)

cat("\n=== MODEL 3: HOURS WORKED ===\n")
summary(model3)
```

# Visualizations

## Plot 1: Employment Rate Trends

```{r plot1-employment-trends}
#| fig-width: 10
#| fig-height: 6

employment_trends <- analysis_data %>%
  group_by(date, retail_industry) %>%
  summarise(
    employment_rate = weighted.mean(employed, WTFINL, na.rm = TRUE) * 100,
    unemployment_rate = weighted.mean(unemployed, WTFINL, na.rm = TRUE) * 100,
    .groups = "drop"
  ) %>%
  mutate(
    industry_type = ifelse(retail_industry == 1, "Retail", "Non-Retail")
  )

plot1_employment <- ggplot(employment_trends, aes(x = date, y = employment_rate, 
                                                  color = industry_type, linetype = industry_type)) +
  geom_line(linewidth = 1.2) +
  geom_vline(xintercept = as.Date("2020-04-01"), linetype = "dashed", alpha = 0.7, color = "red") +
  annotate("text", x = as.Date("2020-04-01"), y = 98, label = "COVID Start", 
           hjust = -0.1, color = "red", size = 3) +
  scale_x_date(date_labels = "%b %Y", date_breaks = "3 months") +
  scale_y_continuous(limits = c(80, 100), labels = percent_format(scale = 1)) +
  scale_color_manual(values = c("Retail" = "#d62728", "Non-Retail" = "#1f77b4")) +
  labs(
    title = "Employment Rate Trends: Retail vs Non-Retail Industries",
    subtitle = "Retail workers experienced steeper employment declines during COVID-19",
    x = "Date",
    y = "Employment Rate (%)",
    color = "Industry",
    linetype = "Industry",
    caption = "Source: IPUMS CPS 2020-2022, weighted estimates"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom",
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 11, color = "gray40")
  )

print(plot1_employment)
```

## Plot 2: COVID Work Impact Patterns

```{r plot2-covid-impact}
#| fig-width: 8
#| fig-height: 6

covid_impact_data <- analysis_data %>%
  filter(!is.na(covid_work_impact)) %>%
  group_by(retail_industry) %>%
  summarise(
    remote_work = weighted.mean(covid_remote, WTFINL, na.rm = TRUE) * 100,
    unable_work = weighted.mean(covid_unable, WTFINL, na.rm = TRUE) * 100,
    total_impact = weighted.mean(covid_work_impact, WTFINL, na.rm = TRUE) * 100,
    .groups = "drop"
  ) %>%
  mutate(
    industry_type = ifelse(retail_industry == 1, "Retail", "Non-Retail")
  ) %>%
  pivot_longer(cols = c(remote_work, unable_work), 
               names_to = "impact_type", values_to = "percentage") %>%
  mutate(
    impact_type = case_when(
      impact_type == "remote_work" ~ "Worked Remotely",
      impact_type == "unable_work" ~ "Unable to Work"
    )
  )

plot2_covid_impact <- ggplot(covid_impact_data, aes(x = industry_type, y = percentage, 
                                                    fill = impact_type)) +
  geom_col(position = "dodge", width = 0.7, alpha = 0.8) +
  geom_text(aes(label = paste0(round(percentage, 1), "%")), 
            position = position_dodge(width = 0.7), vjust = -0.3, size = 3.5) +
  scale_fill_manual(values = c("Worked Remotely" = "#2ca02c", "Unable to Work" = "#ff7f0e")) +
  scale_y_continuous(limits = c(0, 25), labels = percent_format(scale = 1)) +
  labs(
    title = "COVID-19 Work Impact Patterns by Industry",
    subtitle = "Retail workers less likely to work remotely, more likely unable to work",
    x = "Industry Type",
    y = "Percentage of Workers Affected (%)",
    fill = "COVID Impact Type",
    caption = "Source: IPUMS CPS 2020-2022, weighted estimates"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 11, color = "gray40")
  )

print(plot2_covid_impact)
```

## Plot 3: Industry Recovery Timeline

```{r plot3-recovery-timeline}
#| fig-width: 10
#| fig-height: 6

recovery_timeline <- analysis_data %>%
  filter(industry_group %in% c("Retail Trade", "Professional Services", "Manufacturing", "Construction")) %>%
  group_by(industry_group, date) %>%
  summarise(
    employment_rate = weighted.mean(employed, WTFINL, na.rm = TRUE) * 100,
    .groups = "drop"
  )

plot4_recovery <- ggplot(recovery_timeline, aes(x = date, y = employment_rate, 
                                               color = industry_group)) +
  geom_line(linewidth = 1.1, alpha = 0.8) +
  geom_vline(xintercept = as.Date("2020-04-01"), linetype = "dashed", alpha = 0.7, color = "red") +
  scale_x_date(date_labels = "%b %Y", date_breaks = "4 months") +
  scale_y_continuous(limits = c(80, 100), labels = percent_format(scale = 1)) +
  scale_color_viridis_d(option = "plasma", end = 0.8) +
  labs(
    title = "Employment Recovery by Major Industry",
    subtitle = "Retail Trade showed the slowest employment recovery",
    x = "Date",
    y = "Employment Rate (%)",
    color = "Industry",
    caption = "Source: IPUMS CPS 2020-2022, weighted estimates"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom",
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 11, color = "gray40")
  )

print(plot4_recovery)
```

# Key Findings

```{r key-findings}
retail_pre <- retail_comparison %>% filter(industry_type == "Retail", period == "Pre-COVID")
retail_post <- retail_comparison %>% filter(industry_type == "Retail", period == "Post-COVID")
nonretail_pre <- retail_comparison %>% filter(industry_type == "Non-Retail", period == "Pre-COVID")
nonretail_post <- retail_comparison %>% filter(industry_type == "Non-Retail", period == "Post-COVID")

if(nrow(retail_pre) > 0 && nrow(retail_post) > 0) {
  retail_emp_change <- retail_post$employment_rate - retail_pre$employment_rate
  retail_unemp_change <- retail_post$unemployment_rate - retail_pre$unemployment_rate
  
  cat("1. Retail employment rate change:", round(retail_emp_change, 1), "percentage points\n")
  cat("2. Retail unemployment rate change:", round(retail_unemp_change, 1), "percentage points\n")
}

if(nrow(nonretail_pre) > 0 && nrow(nonretail_post) > 0) {
  nonretail_emp_change <- nonretail_post$employment_rate - nonretail_pre$employment_rate
  nonretail_unemp_change <- nonretail_post$unemployment_rate - nonretail_pre$unemployment_rate
  
  cat("3. Non-retail employment rate change:", round(nonretail_emp_change, 1), "percentage points\n")
  cat("4. Non-retail unemployment rate change:", round(nonretail_unemp_change, 1), "percentage points\n")
}

cat("\n=== ANALYSIS COMPLETE ===\n")
cat("Data source: IPUMS CPS 2020-2022 with official codebook positions\n")
cat("Key variables: Employment, Industry, COVID work impacts, Demographics\n")
cat("Analysis covers three research questions with proper survey weights\n")
```

# Conclusions

This analysis provides robust evidence that COVID-19 disproportionately affected retail employment:

1. **Employment Impact**: Retail workers experienced 3.7 percentage point employment decline vs 2.2 points for non-retail
2. **Unemployment Surge**: Retail unemployment increased 65.6% vs 56.4% for other industries  
3. **Work Disruption Patterns**: Retail workers less able to work remotely (5.6% vs 19.4%) but more likely unable to work (8.4% vs 6.4%)
4. **Recovery Speed**: Retail showed slowest employment recovery among major industries

The findings support targeted policy interventions for retail workers and highlight the importance of work flexibility in pandemic resilience.

